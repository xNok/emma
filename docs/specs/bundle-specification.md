# Emma Forms Bundle Specification

**Version:** 1.0  
**Date:** October 10, 2025  
**Status:** Active

## Overview

This document defines the contract between the Form Builder and Form Renderer packages. Both components must adhere to this specification to ensure compatibility.

## Architecture Pattern: ESM Modules

Emma Forms uses modern ES Modules (ESM) for both development and production deployments.

### Why ESM?

- **Native browser support**: No need for complex bundlers in production
- **Smaller bundles**: Tree-shaking and better optimization
- **Cleaner code**: Standard module syntax
- **Future-proof**: Aligns with web standards

## Bundle Structure

### 1. Runtime Module (`emma-forms.esm.js`)

The core FormRenderer class that provides form rendering capabilities.

**Export:**

```javascript
export default class FormRenderer {
  /* ... */
}
export class FormRenderer {
  /* ... */
}
```

**Built by:** `@emma/form-renderer` package  
**Location:** `packages/form-renderer/dist/emma-forms.esm.js`  
**Build command:** `yarn workspace @emma/form-renderer build`

### 2. Form Bundle (`<form-id>.js`)

A generated ESM module specific to each form that includes:

- Embedded form schema
- Auto-initialization logic
- Import of the runtime module

**Template:** `packages/form-builder/src/templates/bundle.template.js`  
**Generated by:** `@emma/form-builder` package  
**Build command:** `emma build <form-id>` or programmatic API

## Form Bundle Template Contract

### Required Structure

```javascript
/**
 * Emma Form Bundle - ESM Module
 * Generated bundle for form: __FORM_ID__
 */

import FormRenderer from './emma-forms.esm.js';

// Form schema embedded in bundle
const FORM_SCHEMA = __FORM_SCHEMA__;

// Auto-initialization function
function init() {
  const containers = document.querySelectorAll(
    '[data-emma-form="__FORM_ID__"]'
  );

  containers.forEach((container, idx) => {
    const containerId = container.id || `emma-form-__FORM_ID__-${idx}`;
    const renderer = new FormRenderer({
      formId: '__FORM_ID__',
      containerId,
      schema: FORM_SCHEMA,
      theme: FORM_SCHEMA.theme,
    });
    renderer.render();
  });
}

// Auto-initialize on DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Export for manual initialization
export { FORM_SCHEMA, FormRenderer };
export default { init, schema: FORM_SCHEMA };
```

### Placeholder Replacements

The form builder MUST replace these placeholders:

| Placeholder       | Replaced With          | Example                            |
| ----------------- | ---------------------- | ---------------------------------- |
| `__FORM_ID__`     | Unique form identifier | `contact-form-001`                 |
| `__FORM_SCHEMA__` | Complete JSON schema   | `{ formId: "...", fields: [...] }` |

## HTML Integration Pattern

### Standard Integration (Auto-init)

```html
<!-- Container with data attribute -->
<div data-emma-form="contact-form-001"></div>

<!-- Load form bundle as ESM module -->
<script type="module" src="contact-form-001.js"></script>
```

**How it works:**

1. Browser loads the form bundle as an ES module
2. Form bundle imports the runtime module
3. DOMContentLoaded event triggers auto-init
4. Auto-init finds all `[data-emma-form="<form-id>"]` containers
5. Each container gets a FormRenderer instance

### Manual Integration

```html
<div id="my-custom-container"></div>

<script type="module">
  import formBundle from './contact-form-001.js';

  // Access the schema and renderer
  console.log('Schema:', formBundle.schema);

  // Manual render
  const renderer = new formBundle.FormRenderer({
    formId: 'contact-form-001',
    containerId: 'my-custom-container',
    schema: formBundle.schema,
  });
  renderer.render();
</script>
```

## File Deployment Structure

When `emma build` completes, the output directory contains:

```
.emma/forms/<form-id>/
├── <form-id>.js              # Form-specific bundle (ESM)
├── emma-forms.esm.js         # Runtime module (ESM)
├── index.html                # Preview page
└── themes/
    └── <theme-name>.css      # Theme CSS
```

## Browser Compatibility

### Minimum Requirements

- ES Module support (all modern browsers)
- Chrome 61+, Firefox 60+, Safari 11+, Edge 16+

### Fallback for Old Browsers

```html
<script type="module" src="contact-form-001.js"></script>
<script nomodule>
  document.getElementById('form-container').innerHTML =
    'This form requires a modern browser.';
</script>
```

## FormRenderer API Contract

The Form Builder assumes the FormRenderer follows this interface:

### Constructor Options

```typescript
interface RenderOptions {
  formId: string; // Unique form identifier
  containerId: string; // DOM element ID to render into
  schema: FormSchema; // Complete form schema
  theme?: string; // Theme name (optional)
  onSubmit?: (data: Record<string, any>) => void;
  onSuccess?: (response: SubmissionResponse) => void;
  onError?: (error: Error) => void;
}
```

### Required Methods

```typescript
class FormRenderer {
  constructor(options: RenderOptions);
  render(): void; // Render the form into the container
}
```

## Testing & Validation

### Builder-Renderer Compatibility Test

The form-builder MUST pass this test:

1. Build a form using the templates
2. Load the generated bundle in a test environment
3. Verify the runtime module is imported correctly
4. Verify the form renders without errors
5. Verify the schema is properly embedded

**Test location:** `packages/form-builder/src/__tests__/integration.test.ts`

### Test Server Compliance

The form-renderer test server demonstrates correct usage:

**Location:** `packages/form-renderer/test-server/`
**Run:** `cd packages/form-renderer/test-server && npm run dev`

The test server:

- Uses ESM imports: `import FormRenderer from '/dist/emma-forms.esm.js'`
- Loads forms using the same pattern as generated bundles
- Serves as reference implementation

## Form Schema Contract

See `shared/types/index.ts` for the complete FormSchema type definition.

### Minimum Required Schema

```json
{
  "formId": "unique-id",
  "name": "Form Name",
  "apiEndpoint": "https://api.example.com/submit/form-id",
  "theme": "default",
  "fields": [
    {
      "id": "field-id",
      "type": "text|email|tel|number|textarea|select|radio|checkbox",
      "label": "Field Label",
      "required": true|false
    }
  ],
  "settings": {
    "submitButtonText": "Submit",
    "successMessage": "Thank you!",
    "errorMessage": "Error occurred"
  }
}
```

## Version Compatibility

### Semantic Versioning

Both packages follow semantic versioning:

- **Major**: Breaking changes to bundle format or API
- **Minor**: New features, backward compatible
- **Patch**: Bug fixes

### Compatibility Matrix

| Form Builder | Form Renderer | Compatible |
| ------------ | ------------- | ---------- |
| 1.x.x        | 1.x.x         | ✅ Yes     |
| 1.x.x        | 2.x.x         | ⚠️ Maybe   |
| 2.x.x        | 1.x.x         | ❌ No      |

## Change Process

When modifying the bundle format or FormRenderer API:

1. Update this specification document
2. Update both packages simultaneously
3. Add integration tests
4. Document breaking changes in CHANGELOG
5. Bump major version if breaking

## References

- Form Renderer: `packages/form-renderer/src/index.ts`
- Form Builder: `packages/form-builder/src/form-builder.ts`
- Bundle Template: `packages/form-builder/src/templates/bundle.template.js`
- Preview Template: `packages/form-builder/src/templates/preview.template.html`
- Test Server: `packages/form-renderer/test-server/`
